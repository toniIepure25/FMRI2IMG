stages:
  prepare_data:
    cmd: python -m fmri2image.data.download_nsd --raw_root data/raw
    deps:
      - src/fmri2image/data/download_nsd.py
      - configs/paths/paths.yaml
    outs:
      - data/raw/nsd:
          persist: true

  roi_extract:
    cmd: >
      python -m fmri2image.data.extract_roi
      --fmriprep_dir data/processed/nsd/fmriprep
      --out_dir data/processed/nsd/roi
      --mode atlas
      --atlas glasser
      --vector_dim 2048
      --subject subj01
    deps:
      - src/fmri2image/data/extract_roi.py
      - configs/data/nsd.yaml
    outs:
      - data/processed/nsd/roi:
          persist: true

  clip_text:
    cmd: >
      python -m fmri2image.text.clip_text
      --captions data/raw/nsd/captions.csv
      --out data/processed/nsd/clip_text.npy
    deps:
      - src/fmri2image/text/clip_text.py
      - data/raw/nsd/captions.csv
    outs:
      - data/processed/nsd/clip_text.npy:
          persist: true

  baseline_train:
    cmd: python -m fmri2image.cli ++run.name=baseline_train train=baseline
    deps:
      - src/fmri2image/pipelines/baseline_train.py
      - src/fmri2image/models/encoders/mlp_encoder.py
      - src/fmri2image/data/nsd_reader.py
      - configs/train/baseline.yaml
      - configs/config.yaml
      - data/processed/nsd/roi/subj01_roi.npy
      - data/processed/nsd/clip_text.npy
    outs:
      - outputs

  pretrain_encoder:
    cmd: >
      python -m fmri2image.selfsupervised.pretrain_fmri
      --images_root data/raw/nsd/images
      --fmri_root data/raw/nsd/fmri
      --captions data/raw/nsd/captions.csv
      --roi_dir data/processed/nsd/roi
      --subject subj01
      --dim 2048
      --mask_ratio 0.5
      --lr 1e-3
      --epochs 2
      --batch_size 16
      --num_workers 4
      --out_ckpt data/artifacts/encoder_pretrained.ckpt
    deps:
      - src/fmri2image/selfsupervised/pretrain_fmri.py
      - src/fmri2image/data/nsd_reader.py
      - data/processed/nsd/roi/subj01_roi.npy
    outs:
      - data/artifacts/encoder_pretrained.ckpt
